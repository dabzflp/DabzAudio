(()=>{var e={306(){async function e(){return window.Meyda||(Array.from(document.querySelectorAll("script")).forEach(e=>{e.src&&e.src.includes("meyda")&&e.remove()}),await new Promise((e,t)=>{const n=document.createElement("script");n.src="js/meyda.min.js",n.onload=e,n.onerror=()=>t(new Error("Failed to load Meyda locally")),document.head.appendChild(n)})),window.Meyda}function t(e){const t=[6.35,2.23,3.48,2.33,4.38,4.09,2.52,5.19,2.39,3.66,2.29,2.88],i=[6.33,2.68,3.52,5.38,2.6,3.53,2.54,4.75,3.98,2.69,3.34,3.17],s=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],r=o(e),l=Math.max(...r),c=r.map(e=>e<.1*l?0:e);let d={name:"Unknown",score:-1/0},u={name:"Unknown",score:-1/0};for(let e=0;e<12;e++){const r=o(n(t,e)),l=o(n(i,e)),h=a(c,r),f=a(c,l);h>d.score?(u=d,d={name:`${s[e]} major`,score:h}):h>u.score&&(u={name:`${s[e]} major`,score:h}),f>d.score?(u=d,d={name:`${s[e]} minor`,score:f}):f>u.score&&(u={name:`${s[e]} minor`,score:f})}return d.score<.15?"Unknown":u.score>.9*d.score?`${d.name} (possible: ${u.name})`:d.name}function n(e,t){return e.slice(t).concat(e.slice(0,t))}function a(e,t){return e.reduce((e,n,a)=>e+n*t[a],0)}function o(e){const t=Math.sqrt(e.reduce((e,t)=>e+t*t,0));return e.map(e=>e/(t||1))}window.dabzAnalysis={analyzeAudioUrl:async function(n,a=()=>{}){const o=new(window.AudioContext||window.webkitAudioContext);a("Fetching audio...");const i=await fetch(n),s=await i.arrayBuffer();a("Decoding audio...");const r=await o.decodeAudioData(s),l=o.createBufferSource();l.buffer=r;const c=o.createGain();l.connect(c),c.connect(o.destination);const d=await e();a("Extracting chroma features...");const u=r.sampleRate,h=r.numberOfChannels>0?r.getChannelData(0):null;if(!h)return{bpm:null,key:"Unknown"};const f=4096,m=new Array(12).fill(0);let p=0;for(let e=0;e+f<=h.length;e+=2048){const t=h.slice(e,e+f),n=d.extract("chroma",t,{bufferSize:f,sampleRate:u});if(Array.isArray(n)&&12===n.length){for(let e=0;e<12;e++)m[e]+=n[e];p++}e%102400==0&&a(`Chroma: ${(e/h.length*100).toFixed(1)}%`)}if(0===p)return{bpm:null,key:"Unknown"};const y=t(m.map(e=>e/p));a("Estimating BPM (Realtime Analyzer)...");const w=await estimateBPMWithRealtime(r);return o.close(),{bpm:w,key:y}},analyzeAudioBuffer:async function(n,a=()=>{}){try{const o=new(window.AudioContext||window.webkitAudioContext);a("Decoding audio...");const i=await o.decodeAudioData(n);console.log("Decoded audioBuffer:",i);const s=await e();console.log("Meyda loaded:",!!s),a("Extracting chroma features...");const r=i.sampleRate,l=i.numberOfChannels>0?i.getChannelData(0):null;if(console.log("Channel data:",l?l.length:"none"),!l)return console.warn("No channel data"),{bpm:null,key:"Unknown"};const c=4096,d=2048,u=new Array(12).fill(0);let h=0;for(let e=0;e+c<=l.length;e+=d){const t=l.slice(e,e+c),n=s.extract("chroma",t,{bufferSize:c,sampleRate:r});if(Array.isArray(n)&&12===n.length){for(let e=0;e<12;e++)u[e]+=n[e];h++}e%(50*d)==0&&a(`Chroma: ${(e/l.length*100).toFixed(1)}%`),e%(50*d)==0&&console.log(`Chroma frame ${e}:`,n)}if(0===h)return console.warn("No valid chroma frames"),{bpm:null,key:"Unknown"};const f=u.map(e=>e/h),m=t(f);console.log("Chroma avg:",f,"Estimated key:",m),a("Estimating BPM (Energy Peaks)...");const p=await async function(e){const t=e.getChannelData(0),n=e.sampleRate,a=[];for(let e=0;e+1024<t.length;e+=512){let n=0;for(let a=0;a<1024;a++){const o=t[e+a];n+=o*o}a.push(n)}const o=[];for(let e=0;e<a.length;e++){let t=0;for(let n=Math.max(0,e-5);n<=Math.min(a.length-1,e+5);n++)t+=a[n];o.push(t/(Math.min(a.length-1,e+5)-Math.max(0,e-5)+1))}const i=Math.floor(n/60);let s=0,r=-1/0;for(let e=Math.floor(n/180);e<=i;e++){let t=0;for(let n=0;n<o.length-e;n++)t+=o[n]*o[n+e];t>r&&(r=t,s=e)}if(0===s)return null;let l=60/(512*s/n);for(;l<70;)l*=2;for(;l>180;)l/=2;return Math.round(l)}(i);return console.log("Estimated BPM:",p),o.close(),{bpm:p,key:m}}catch(e){return console.error("analyzeAudioBuffer error:",e),{bpm:null,key:"Unknown"}}},estimateKeyFromChroma:t}},678(){document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("audioFile"),t=document.getElementById("uploadBtn"),n=document.getElementById("status");function a(e){n&&(n.textContent=e)}async function o(e){try{a("Analyzing file...");const t=new FileReader;t.onload=async function(t){try{const n=t.target.result;if(a("Running analysis..."),!window.dabzAnalysis||!window.dabzAnalysis.analyzeAudioBuffer)throw new Error("Analysis module not loaded. Include js/analysis.bundle.js");const o=await window.dabzAnalysis.analyzeAudioBuffer(n,a);a("Done");const i=document.getElementById("bpmResult"),s=document.getElementById("keyResult"),r=document.getElementById("player");if(i&&(i.textContent=o.bpm??"Unknown"),s&&(s.textContent=o.key??"Unknown"),r){const t=new Blob([n],{type:e.type});r.src=URL.createObjectURL(t)}}catch(e){a("Error: "+e.message),console.error(e)}},t.onerror=function(){a("Error reading file")},t.readAsArrayBuffer(e)}catch(e){a("Error: "+e.message),console.error(e)}}t?t.addEventListener("click",()=>{const t=e.files&&e.files[0];if(!t)return alert("Choose a file first");o(t)}):e&&e.addEventListener("change",e=>{const t=e.target.files&&e.target.files[0];t&&o(t)})})}},t={};function n(a){var o=t[a];if(void 0!==o)return o.exports;var i=t[a]={exports:{}};return e[a](i,i.exports,n),i.exports}(()=>{"use strict";async function e(e,t=.2,n=.95,a=.05){let o=n;do{if(o-=a,await e(o))break}while(o>t)}function t(e,t=5){return e.sort((e,t)=>t.count-e.count).splice(0,t)}function a(e){let t=[];for(let n=0;n<e.length;n++)for(let a=0;a<10;a++){let o=e[n],i=e[n+a]-o;if(!t.some(e=>e.interval===i&&(e.count+=1,e.count))){let e={interval:i,count:1};t.push(e)}}return t}function o({audioSampleRate:e,intervalCounts:t}){let n=[];for(let a of t){if(0===a.interval)continue;a.interval=Math.abs(a.interval);let t=60/(a.interval/e);for(;t<90;)t*=2;for(;t>180;)t/=2;if(t=Math.round(t),!n.some(e=>e.tempo===t&&(e.count+=a.count,e.count))){let e={tempo:t,count:a.count,confidence:0};n.push(e)}}return n}var i=()=>function(e=.2,t=.95,n=.05){let a={},o=t;do{o-=n,a[o.toString()]=[]}while(o>e);return a}(),s=()=>function(e=.2,t=.95,n=.05){let a={},o=t;do{o-=n,a[o.toString()]=0}while(o>e);return a}(),r=class{constructor(e={}){this.options={continuousAnalysis:!1,stabilizationTime:2e4,muteTimeInIndexes:1e4,debug:!1},this.minValidThreshold=.2,this.validPeaks=i(),this.nextIndexPeaks=s(),this.skipIndexes=1,this.effectiveBufferTime=0,this.computedStabilizationTimeInSeconds=0,Object.assign(this.options,e),this.updateComputedValues()}updateComputedValues(){this.computedStabilizationTimeInSeconds=this.options.stabilizationTime/1e3}reset(){this.minValidThreshold=.2,this.validPeaks=i(),this.nextIndexPeaks=s(),this.skipIndexes=1,this.effectiveBufferTime=0}async clearValidPeaks(t){this.minValidThreshold=Number.parseFloat(t.toFixed(2)),await e(async e=>(e<t&&void 0!==this.validPeaks[e]&&(delete this.validPeaks[e],delete this.nextIndexPeaks[e]),!1))}async analyzeChunck({audioSampleRate:n,channelData:i,bufferSize:s,postMessage:r}){this.options.debug&&r({message:"ANALYZE_CHUNK",data:i}),this.effectiveBufferTime+=s;let l=s*this.skipIndexes,c=l-s;await this.findPeaks({audioSampleRate:n,channelData:i,bufferSize:s,currentMinIndex:c,currentMaxIndex:l,postMessage:r}),this.skipIndexes++;let d=await async function({audioSampleRate:n,data:i}){let s=!1,r=.2;return await e(async e=>!!s||(i[e].length>15&&(s=!0,r=e),!1)),s&&r?{bpm:t(o({audioSampleRate:n,intervalCounts:a(i[r])})),threshold:r}:{bpm:[],threshold:r}}({audioSampleRate:n,data:this.validPeaks}),{threshold:u}=d;r({message:"BPM",data:d}),this.minValidThreshold<u&&(r({message:"BPM_STABLE",data:d}),await this.clearValidPeaks(u)),this.options.continuousAnalysis&&this.effectiveBufferTime/n>this.computedStabilizationTimeInSeconds&&(this.reset(),r({message:"ANALYZER_RESETED"}))}async findPeaks({audioSampleRate:t,channelData:n,bufferSize:a,currentMinIndex:o,currentMaxIndex:i,postMessage:s}){await e(async e=>{if(this.nextIndexPeaks[e]>=i)return!1;let r=this.nextIndexPeaks[e]%a,{peaks:l,threshold:c}=function({audioSampleRate:e,data:t,threshold:n,offset:a=0}){let o=[],i=function(e,t){return Math.round(.25*t)}(0,e),{length:s}=t;for(let e=a;e<s;e+=1)t[e]>n&&(o.push(e),e+=i);return{peaks:o,threshold:n}}({audioSampleRate:t,data:n,threshold:e,offset:r});if(0===l.length)return!1;for(let e of l){let t=o+e;this.nextIndexPeaks[c]=t+this.options.muteTimeInIndexes,this.validPeaks[c].push(t),this.options.debug&&s({message:"VALID_PEAK",data:{threshold:c,index:t}})}return!1},this.minValidThreshold)}};n(306),n(678),window.RealTimeBpmAnalyzer=r,window.RealTimeBpmAnalyzer.analyze=r.analyze})()})();