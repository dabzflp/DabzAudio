(()=>{var e={306(){async function e(){return window.Meyda||await new Promise((e,n)=>{const t=document.createElement("script");t.src="js/meyda.min.js",t.onload=e,t.onerror=()=>n(new Error("Failed to load Meyda locally")),document.head.appendChild(t)}),window.Meyda}function n(e){const n=[6.35,2.23,3.48,2.33,4.38,4.09,2.52,5.19,2.39,3.66,2.29,2.88],t=[6.33,2.68,3.52,5.38,2.6,3.53,2.54,4.75,3.98,2.69,3.34,3.17],l=r(e);let i={name:"Unknown",score:-1/0};const c=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];for(let e=0;e<12;e++){const s=r(o(n,e)),d=r(o(t,e)),u=a(l,s),m=a(l,d);u>i.score&&(i={name:`${c[e]} major`,score:u}),m>i.score&&(i={name:`${c[e]} minor`,score:m})}return i.score<.15?"Unknown":i.name}async function t(e){try{if(console.log("BPM estimation: using window.RealTimeBpmAnalyzer"),"function"==typeof window.RealTimeBpmAnalyzer){const n=new window.RealTimeBpmAnalyzer({scriptNodeBufferSize:4096,pushTime:500,calculateByFft:!0}),t=e.getChannelData(0),o=4096;for(let e=0;e<t.length;e+=o)n.input(t.slice(e,e+o));const a="function"==typeof n.getBpm?n.getBpm():null;if(console.log("BPM estimation: getBpm result:",a),Array.isArray(a)&&a.length)return Math.round(a[0].tempo)}else console.warn("BPM estimation: RealTimeBpmAnalyzer not found on window")}catch(e){console.warn("BPM estimate failed:",e)}return console.warn("BPM estimation: returning null"),null}function o(e,n){return e.slice(n).concat(e.slice(0,n))}function a(e,n){return e.reduce((e,t,o)=>e+t*n[o],0)}function r(e){const n=Math.sqrt(e.reduce((e,n)=>e+n*n,0));return e.map(e=>e/(n||1))}window.dabzAnalysis={analyzeAudioUrl:async function(o,a=()=>{}){const r=new(window.AudioContext||window.webkitAudioContext);a("Fetching audio...");const l=await fetch(o),i=await l.arrayBuffer();a("Decoding audio...");const c=await r.decodeAudioData(i),s=r.createBufferSource();s.buffer=c;const d=r.createGain();s.connect(d),d.connect(r.destination);const u=await e();a("Extracting chroma features...");const m=c.sampleRate,f=c.numberOfChannels>0?c.getChannelData(0):null;if(!f)return{bpm:null,key:"Unknown"};const y=4096,w=new Array(12).fill(0);let g=0;for(let e=0;e+y<=f.length;e+=2048){const n=f.slice(e,e+y),t=u.extract("chroma",n,{bufferSize:y,sampleRate:m});if(Array.isArray(t)&&12===t.length){for(let e=0;e<12;e++)w[e]+=t[e];g++}e%102400==0&&a(`Chroma: ${(e/f.length*100).toFixed(1)}%`)}if(0===g)return{bpm:null,key:"Unknown"};const p=n(w.map(e=>e/g));a("Estimating BPM (Realtime Analyzer)...");const h=await t(c);return r.close(),{bpm:h,key:p}},analyzeAudioBuffer:async function(o,a=()=>{}){try{const r=new(window.AudioContext||window.webkitAudioContext);a("Decoding audio...");const l=await r.decodeAudioData(o);console.log("Decoded audioBuffer:",l);const i=await e();console.log("Meyda loaded:",!!i),a("Extracting chroma features...");const c=l.sampleRate,s=l.numberOfChannels>0?l.getChannelData(0):null;if(console.log("Channel data:",s?s.length:"none"),!s)return console.warn("No channel data"),{bpm:null,key:"Unknown"};const d=4096,u=2048,m=new Array(12).fill(0);let f=0;for(let e=0;e+d<=s.length;e+=u){const n=s.slice(e,e+d),t=i.extract("chroma",n,{bufferSize:d,sampleRate:c});if(Array.isArray(t)&&12===t.length){for(let e=0;e<12;e++)m[e]+=t[e];f++}e%(50*u)==0&&a(`Chroma: ${(e/s.length*100).toFixed(1)}%`),e%(50*u)==0&&console.log(`Chroma frame ${e}:`,t)}if(0===f)return console.warn("No valid chroma frames"),{bpm:null,key:"Unknown"};const y=m.map(e=>e/f),w=n(y);console.log("Chroma avg:",y,"Estimated key:",w),a("Estimating BPM (Realtime Analyzer)...");const g=await t(l);return console.log("Estimated BPM:",g),r.close(),{bpm:g,key:w}}catch(e){return console.error("analyzeAudioBuffer error:",e),{bpm:null,key:"Unknown"}}},estimateKeyFromChroma:n}},678(){document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("audioFile"),n=document.getElementById("uploadBtn"),t=document.getElementById("status");function o(e){t&&(t.textContent=e)}async function a(e){try{o("Analyzing file...");const n=new FileReader;n.onload=async function(n){try{const t=n.target.result;if(o("Running analysis..."),!window.dabzAnalysis||!window.dabzAnalysis.analyzeAudioBuffer)throw new Error("Analysis module not loaded. Include js/analysis.bundle.js");const a=await window.dabzAnalysis.analyzeAudioBuffer(t,o);o("Done");const r=document.getElementById("bpmResult"),l=document.getElementById("keyResult"),i=document.getElementById("player");if(r&&(r.textContent=a.bpm??"Unknown"),l&&(l.textContent=a.key??"Unknown"),i){const n=new Blob([t],{type:e.type});i.src=URL.createObjectURL(n)}}catch(e){o("Error: "+e.message),console.error(e)}},n.onerror=function(){o("Error reading file")},n.readAsArrayBuffer(e)}catch(e){o("Error: "+e.message),console.error(e)}}n?n.addEventListener("click",()=>{const n=e.files&&e.files[0];if(!n)return alert("Choose a file first");a(n)}):e&&e.addEventListener("change",e=>{const n=e.target.files&&e.target.files[0];n&&a(n)})})}},n={};function t(o){var a=n[o];if(void 0!==a)return a.exports;var r=n[o]={exports:{}};return e[o](r,r.exports,t),r.exports}t.n=e=>{var n=e&&e.__esModule?()=>e.default:()=>e;return t.d(n,{a:n}),n},t.d=(e,n)=>{for(var o in n)t.o(n,o)&&!t.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:n[o]})},t.o=(e,n)=>Object.prototype.hasOwnProperty.call(e,n),(()=>{"use strict";t(306),t(678)})()})();